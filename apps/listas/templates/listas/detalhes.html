{% extends "base.html" %} 

{% block title %}Tisk Task - {{ lista.nome }}{% endblock %}

{% block conteudo %}

<header>
    <h1 class="logo">Tisk Task</h1>
    <div class="nome-lista-container">
        <form method="POST"> <!-- muda o nome da lista -->
            {% csrf_token %}
            <input 
                type="text" 
                name="nome_lista"
                value="{{ lista.nome }}" 
                onchange="this.form.submit()"
                class="nome-lista">
            <!-- imagem aq pra representar edi√ß√£o -->
        </form>
    </div>
    <a href="#"><button>Config</button></a>
</header>

<div class="progresso-container">
    <div class="barra-progresso-base">
        <div class="barra-progresso-fill" 
             style="width: {{ lista.calcular_progresso }}%; background-color: lightblue">
            {{ lista.calcular_progresso|floatformat:0 }}%
        </div>
    </div>
</div>

<div class="aside">
    <h2>Prioridade da lista:</h2>
    <form method="POST"> <!-- muda a prioridade da lista -->
        {% csrf_token %}
        <button type="submit" name="prioridade_lista" value="alta" 
                class="{% if lista.prioridade == 'alta' %}selected-{{lista.prioridade}}{% endif %}">Alta</button>
                
        <button type="submit" name="prioridade_lista" value="media" 
                class="{% if lista.prioridade == 'media' %}selected-{{lista.prioridade}}{% endif %}">M√©dia</button>
                
        <button type="submit" name="prioridade_lista" value="baixa" 
                class="{% if lista.prioridade == 'baixa' %}selected-{{lista.prioridade}}{% endif %}">Baixa</button>
    </form>

    <a href="{% url 'apagar_tarefas_concluidas' lista_id=lista.pk %}">Apagar todas as tarefas concluidas</a>
    <a href="{% url 'apagar_lista' lista_id=lista.pk %}">Apagar lista</a>
    <a href="{% url 'home' %}">Voltar para o in√≠cio</a>
</div>

<!-- Tabela com as tarefas -->
<table class="tabela-tarefas">
    <tbody>
        {% for tarefa in tarefas %}
            <tr class="{% if tarefa.concluido %}concluida{% endif %}">
                <td> 
                    <form method="POST" action="{% url 'toggle_tarefa' lista_id=lista.pk tarefa_id=tarefa.pk %}">
                        {% csrf_token %}
                        <input type="checkbox" 
                               name="concluido" 
                               onchange="this.form.submit()" 
                               {% if tarefa.concluido %}checked{% endif %}>
                    </form>
                </td>
                <td> 
                    <form method="POST" action="{% url 'editar_tarefa' lista_id=lista.pk tarefa_id=tarefa.pk %}"> 
                        {% csrf_token %}
                        <input 
                            type="text" 
                            name="nome_tarefa"
                            value="{{ tarefa.nome }}" 
                            onchange="this.form.submit()">
                    </form>
                </td>
                <td> 
                    <form method="POST" action="{% url 'editar_tarefa' lista_id=lista.pk tarefa_id=tarefa.pk %}"> 
                        {% csrf_token %}
                        <input 
                            type="date" 
                            name="prazo_tarefa"
                            value="{{ tarefa.prazo|date:'Y-m-d' }}" 
                            onchange="this.form.submit()">
                    </form>
                </td>
                <td> 
                    <div id="tags-visual-{{ tarefa.pk }}">
                        {% for tag in tarefa.tags.all %} 
                            <span class="tag-balao" data-tag-id="{{ tag.pk }}">{{ tag.nome }}</span>
                        {% endfor %}
                    </div>
                    
                    <button onclick="toggleDropdown(event, {{ tarefa.pk }})">‚ûï</button>
                </td>
                 <td>
                    <a href="{% url 'apagar_tarefa' lista_id=lista.pk tarefa_id=tarefa.pk %}">üóëÔ∏è</a>
                </td>
            </tr>
        {% endfor %}
        
        <tr class="adicionar-tarefa">
            <form method="POST" action="{% url 'adicionar_tarefa' lista_id=lista.pk %}">
                {% csrf_token %}
                
                <td></td>
                <td>
                    <input type="text" 
                           name="titulo_tarefa" 
                           placeholder="Adicionar nova tarefa..." 
                           id="nova-tarefa-input"
                           required>
                </td>
                <td>
                    <input type="date" 
                           name="prazo">
                </td>
                <td>
                    <button type="submit" style="display: none;" id="adicionar-btn">Adicionar</button>
                    <label for="adicionar-btn" class="adicionar-icone" onclick="document.getElementById('nova-tarefa-input').focus()">+</label>
                </td>
                <td></td>
            </form>
        </tr>
    </tbody>
</table>

<div class="drop-down-tags" id="seletor-tags-modal" style="display: none; position: absolute; border: 1px black solid; background-color: white;">
    
    <form method="POST" id="form-vincular-tags">
        {% csrf_token %}
        <input type="hidden" name="tarefa_id" id="input-tarefa-id">
        
        <p>Selecione as Tags:</p>
        
        <div class="tag-listagem-container">
            {% for tag in tags %} 
                <label class="tag-checkbox-item">
                    <input type="checkbox" 
                           name="marcar_tag"       id="tag-checkbox-{{ tag.pk }}"
                           value="{{ tag.pk }}"    onchange="submitFormDelayed()"> {{ tag.nome }}
                </label>
            {% empty %}
                <p>Nenhuma tag dispon√≠vel. <a href="{% url 'gerenciar_tags' %}">Crie uma agora</a>.</p>
            {% endfor %}
        </div>
        
        <button type="submit" style="display: none;">Salvar</button>
    </form>
    
    <button onclick="fecharDropdown()">Fechar</button>
</div>

<script>
    const LISTA_ID = {{ lista.pk }};
    let submitTimeout = null;

    document.addEventListener('DOMContentLoaded', function() {
        const novaTarefaInput = document.getElementById('nova-tarefa-input');

        if (novaTarefaInput) {
            novaTarefaInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault(); 
                    this.form.submit();
                }
            });
        }
    });

    function fecharDropdown() { // abrir/fechar dropdown
        document.getElementById('seletor-tags-modal').style.display = 'none';
    }

    function submitFormDelayed() { // submeter para a url
        if (submitTimeout) {
            clearTimeout(submitTimeout);
        }
        
        submitTimeout = setTimeout(() => {
            const tarefaId = document.getElementById('input-tarefa-id').value;
            const form = document.getElementById('form-vincular-tags');
            

            form.action = `/listas/${LISTA_ID}/${tarefaId}/vincular_tag/`;
            
            form.submit(); 
        }, 300); 
    }

    function toggleDropdown(event, tarefaId) { // marcar as tags e posicionar o dropdown
        const modal = document.getElementById('seletor-tags-modal');
        const inputTarefaId = document.getElementById('input-tarefa-id');

        inputTarefaId.value = tarefaId;

        const allCheckboxes = modal.querySelectorAll('input[name="marcar_tag"]');
        allCheckboxes.forEach(cb => cb.checked = false);

        const tagsContainer = document.getElementById(`tags-visual-${tarefaId}`);
        if (tagsContainer) {
            const tagsAtuais = tagsContainer.querySelectorAll('.tag-balao');
            
            tagsAtuais.forEach(tagBalao => {
                const tagId = tagBalao.dataset.tagId; 
                const checkbox = document.getElementById(`tag-checkbox-${tagId}`);
                if (checkbox) {
                    checkbox.checked = true;
                }
            });
        }
        
        const rect = event.target.getBoundingClientRect();
        modal.style.top = `${rect.bottom + window.scrollY + 5}px`;
        modal.style.left = `${rect.left + window.scrollX}px`;
        modal.style.display = 'block';
    }

</script>

{% endblock %}